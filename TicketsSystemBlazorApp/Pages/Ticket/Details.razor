

@page "/ticket/details/{Id:int}"
@using System.Security.Claims
@inject TicketServiceWrapper Wrapper
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider

<h3 class="text-2xl font-bold mb-4">Ticket Details</h3>

@if (isLoading)
{
    <p>Loading ticket...</p>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="text-red-600">@errorMessage</div>
}
else if (ticket == null)
{
    <p>No ticket found.</p>
}
else
{
    <div class="border rounded-lg shadow-md p-4 bg-white max-w-lg space-y-2">
        <p><strong>ID:</strong> @ticket.TicketId</p>
        <p><strong>Title:</strong> @ticket.Title</p>
        <p><strong>Description:</strong> @ticket.Description</p>

        <p><strong>Client:</strong> @(client != null ? $"{client.FirstName} {client.LastName}" : "N/A")</p>
        <p><strong>Category:</strong> @(categoryName ?? "Unknown")</p>

        <p><strong>Created:</strong> @ticket.CreatedAt.ToString("yyyy-MM-dd HH:mm")</p>
        <p><strong>Resolved:</strong> @(ticket.ResolvedAt?.ToString("yyyy-MM-dd HH:mm") ?? "Not resolved")</p>
        <p><strong>Assigned To:</strong> @(string.IsNullOrEmpty(ticket.AssignToUserName) ? "Unassigned" : ticket.AssignToUserName)</p>
        <p><strong>Comments:</strong> @(string.IsNullOrEmpty(ticket.Comments) ? "No comments" : ticket.Comments)</p>


        <div class="flex gap-2 mt-4">
            <button class="bg-green-600 text-black px-4 py-2 rounded" @onclick="StartTicket">Start</button>
            <button class="bg-red-600 text-black px-4 py-2 rounded" @onclick="CloseTicket">Close</button>
            <button class="bg-blue-600 text-black px-4 py-2 rounded" @onclick="ReopenTicket">Reopen</button>
        </div>
    </div>

    <button class="bg-gray-600 text-black px-4 py-2 rounded mt-4" @onclick="GoBack">
        Back
    </button>
}

@code {
    [Parameter] public int Id { get; set; }

    private TicketDetailsDto? ticket;
    private List<TicketCategoryReadOnlyDto>? categories;
    private ClientAccountDetailsDto? client;

    private bool isLoading = true;
    private string? errorMessage;

    private string? categoryName;

    protected override async Task OnInitializedAsync()
    {
        await LoadTicketAsync();
        await LoadExtraDataAsync();
        isLoading = false;
    }

    private async Task LoadTicketAsync()
    {
        try
        {
            ticket = await Wrapper.GetTicketByIdAsync(Id);

            if (ticket == null)
            {
                errorMessage = "Ticket not found.";
                return;
            }

            // Load client
            client = await Wrapper.GetClientAccountByIdAsync(ticket.ClientAccountId);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading ticket: {ex.Message}";
        }
    }

    private async Task LoadExtraDataAsync()
    {
        try
        {
            if (ticket == null)
                return;

            // Load all categories
            var categoryList = await Wrapper.GetTicketCategoriesAsync();
            categories = categoryList.ToList();

            // Find category name
            categoryName = categories
                .FirstOrDefault(c => c.TicketCategoryId == ticket.TicketCategoryId)
                ?.Name;
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error loading extra data: " + ex.Message);
        }
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo("/ticket");
    }
    private async Task StartTicket()
    {
        try
        {
            await Wrapper.StartTicketAsync(ticket!.TicketId);
            // Reload details after action
            await LoadTicketAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error starting ticket: {ex.Message}";
        }
    }

    private async Task CloseTicket()
    {
        try
        {
            await Wrapper.CloseTicketAsync(ticket!.TicketId);
            await LoadTicketAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error closing ticket: {ex.Message}";
        }
    }

    private async Task ReopenTicket()
    {
        try
        {
            await Wrapper.ReopenTicketAsync(ticket!.TicketId);
            await LoadTicketAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error reopening ticket: {ex.Message}";
        }
    }



}
